stages:
  - test
  - report
  - pages

e2e-tests:
  stage: test
  image: python:3.10
  variables:
    SELENIUM_HEADLESS: "1"
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - pytest -v
  artifacts:
    when: always
    paths:
      - allure-results/
      - screenshots/
    allow_failure: true


allure-report:
  stage: report
  image: eclipse-temurin:11-jre
  needs:
    - job: e2e-tests
      artifacts: true
  script:
    - apt-get update && apt-get install -y wget unzip
    - wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.zip
    - unzip allure-2.25.0.zip
    - mv allure-2.25.0 /opt/allure
    - ln -s /opt/allure/bin/allure /usr/bin/allure
    - allure generate allure-results -o allure-report --clean
  artifacts:
    when: always
    paths:
      - allure-report/


pages:
  stage: pages
  needs:
    - allure-report
  script:
    - mkdir -p public
    - cp -r allure-report/* public/
  artifacts:
    paths:
      - public
